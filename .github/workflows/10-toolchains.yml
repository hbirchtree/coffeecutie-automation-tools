name: Build toolchains
'on':
    push:
        branches:
            - master
        tags:
            - v*

jobs:
    ReleaseCreate:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v2
              with:
                  path: source
            - name: Checking branch
              run: echo "Currently received $GITHUB_REF"
            - name: Create release
              if: startsWith(github.ref, 'refs/tags/')
              working-directory: ${{ github.workspace }}/source
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: >
                  gh release create ${{ github.ref }}
                  -R ${{ github.repository }}
                  -p
                  -t 'Automatic Release ${{ github.ref }}'
                  -n 'Automatically generated by Actions'
                  --target ${{ github.sha }}

    Ubuntu:
        runs-on: ubuntu-latest
        needs: ReleaseCreate
        env:
            CTNG: '${{ github.workspace }}/crosstool-ng-master/ct-ng'
        strategy:
            matrix:
                system:
                    - name: beaglebone
                      arch: arm-unknown-linux-gnueabihf
                    - name: raspberry
                      arch: arm-unknown-linux-gnueabihf
                    - name: desktop
                      arch: x86_64-unknown-linux-gnu
        steps:
            - uses: actions/checkout@v2
              with:
                  path: source
            - name: Download dependencies
              run: sudo apt install -y build-essential flex bison help2man libtool-bin
            - name: Download crosstool-ng
              run: |
                  wget https://github.com/crosstool-ng/crosstool-ng/archive/master.tar.gz
                  tar xvf master.tar.gz
            - name: Install crosstool-ng
              working-directory: ${{ github.workspace }}/crosstool-ng-master
              run: |
                  ./bootstrap
                  ./configure --enable-local
                  make -j4
            - name: Build toolchain
              working-directory: ${{ github.workspace }}/source/toolchains/${{ matrix.system.name }}-ct/compiler
              run: |
                  $CTNG build.4 -e CT_PREFIX=${{ github.workspace }}/build
            - name: Zip up toolchain
              working-directory: ${{ github.workspace }}/build/${{ matrix.system.arch }}
              run: |
                  tar Jcf ${{ github.workspace }}/${{ matrix.system.name }}-${{ matrix.system.arch }}.tar.xz *
            - name: Create toolchain artifact
              uses: actions/upload-artifact@v2
              with:
                  name: ${{ matrix.system.name }}-${{ matrix.system.arch }}
                  path: ${{ github.workspace }}/build/${{ matrix.system.arch }}
            - name: Upload to release
              if: startsWith(github.ref, 'refs/tags/')
              working-directory: ${{ github.workspace }}/source
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: >
                  gh release upload ${{ github.ref }}
                  ${{ github.workspace }}/${{ matrix.system.name }}-${{ matrix.system.arch }}.tar.xz
                  -R ${{ github.repository }}
                  -p
                  -t 'Automatic Release ${{ github.ref }}'
                  -n 'Automatically generated by Actions'
                  --target ${{ github.sha }}
            - name: Build sysroot
              if: false
              working-directory: ${{ github.workspace }}/source/toolchains
              run: |
                  make ${{ matrix.system }}.sysroot
